# 校园灯控MQTT订阅

| 版本号 |                           修改内容                           |  修改人   | 修改日期  |
| :----: | :----------------------------------------------------------: | :-------: | --------- |
|  v1.0  |                         确定基础逻辑                         |   潘东    |           |
|  V2.1  | 调整单独控制灯开关的数据格式；分开客户端发的指令和设备端发的指令；调整订阅主题逻辑；增加读取设备状态指令； | 潘东/Qurn |           |
|  V2.2  |                   调整设备端上报状态指令；                   | 潘东/Qurn |           |
|  V2.3  |                  修改部分协议；简化文档说明                  | 潘东/Qurn | 2023.5.17 |

## 使用前必读

所有主题均以`schoolLight/`作为开头，后根据不同的需求再细分不同的主题。

假设学校A的topic为`A-ID-1234`，教学楼A栋topic为`A-BUILDING-1234`，A栋1楼topic为`A-FLOOR-1234`，501室的topic为`A-ROOM-1234`，其中有1台主控板控制4个区域共20盏灯，主控板topic为`A-CONTROL-1234`，区域划分为`A区、B区、C区、D区`，区域下的灯根据索引进行控制。

下面所有订阅主题例子，均以上述环境作为基础。**注意：所有topic信息请以服务端返回为准，长度最长为22个字符。**

## MQTT协议通讯说明

## 串口协议通讯说明

**波特率：**`115200`

**消息格式：**

| SOF     | data_length    | seq         | CRC16          | data       |
| ------- | -------------- | ----------- | -------------- | ---------- |
| 2-byte  | 2-byte         | 1-byte      | 2-byte         | n-byte     |
| `55 AA` | `用户数据长度` | `0~255递增` | `校验用户数据` | `用户数据` |

## 服务端指令

### 控制灯开关

**通讯方式：**`MQTT`

**主题：**`schoolLight/<区域层级>`

**服务质量：**`qos1`

**消息格式：**`josn`

**消息内容（方式一，单组参数）：**

|    key     |  type  | 是否必须 |         备注         |
| :--------: | :----: | :------: | :------------------: |
|    cmd     | string |    是    |  操作命令，`switch`  |
|  location  | string |    否    |        灯区域        |
| lightIndex |  int   |    否    |  灯索引号，从0开始   |
|   status   |  int   |    是    | 灯状态，0：开，1：关 |

**示例：**

主题：schoolLight/A-ID-1234/A-BUILDING-1234/A-FLOOR-1234/A-ROOM-1234/A-CONTROL-1234

```json
// 控制该课室所有灯开
{
  "cmd": "switch",
  "status": 0
}

// 控制该课室A区域所有灯开
{
  "cmd": "switch",
  "location": "A",
  "status": 0
}

// 控制该课室所有区域第1盏灯灯开
{
  "cmd": "switch",
  "lightIndex": 0,
  "status": 0
}

// 控制该课室A区域第1盏灯灯开
{
  "cmd": "switch",
  "location": "A",
  "lightIndex": 0,
  "status": 0
}
```

**消息内容（方式二，多组参数）：**

| key  |  type  | 是否必须 |             备注             |
| :--: | :----: | :------: | :--------------------------: |
| cmd  | string |    是    |  操作命令，此处固定为switch  |
| data | array  |    是    | 参数列表，元素格式参考方式一 |

**示例：**

主题：schoolLight/A-ID-1234/A-BUILDING-1234/A-FLOOR-1234/A-ROOM-1234/A-CONTROL-1234

```json
{
  "cmd": "switch",
  "data": [
    // 参数列表，元素格式参考方式一
  ]
}

// 控制A区域与B区域第1盏灯打开
{
  "cmd": "switch",
  "data": [
    {
      "location": "A",
      "lightIndex": 0,
      "status": 0
    },
    {
      "location": "B",
      "lightIndex": 0,
      "status": 0
    }
  ]
}
```

### 读取设备网关状态

**通讯方式：**`MQTT`

**主题：**`schoolLight/学校topic/建筑topic/楼层topic/房间topic/设备topic`

**服务质量：**`qos1`

**消息内容：**

| key  |  type  | 是否必须 |          备注          |
| :--: | :----: | :------: | :--------------------: |
| cmd  | string |    是    | 操作命令，`get_status` |

**示例：**

读取学校A，教学楼A栋1楼501室的设备状态。

主题：schoolLight/A-ID-1234/A-BUILDING-1234/A-FLOOR-1234/A-ROOM-1234/A-CONTROL-1234

```json
{
  "cmd": "get_status"
}
```

## 设备网关指令

### 控制灯开关

**通讯方式：**`串口`

**消息格式：**`二进制`

| 协议头部   | 命令码    | 区域      | 位置     | 状态             |
| ---------- | --------- | --------- | -------- | ---------------- |
| 7-byte     | 1-byte    | 1-byte    | 1-byte   | 1-byte           |
| 见协议说明 | `01`(DEC) | `ASCII码` | `十进制` | `0:关灯, 1:开灯` |

示例：

```
// 控制A区域第1盏灯打开
55 AA 00 04 01 9C 91 01 41 01 01 
```

消息说明：

- 需要所有灯亮时传入区域或位置为`FF`


### 获取设备当前状态

**通讯方式：**`串口`

**消息格式：**`二进制`

| 协议头部   | 命令码    |
| ---------- | --------- |
| 7-byte     | 1-byte    |
| 见协议说明 | `05`(DEC) |

示例：

```
55 AA 00 01 01 43 7F 05
```

### 上报设备网关当前状态

**通讯方式：**`MQTT`

**主题：**`lightGateway`

**消息格式：**`josn`

**服务质量：**`qos1`

**消息内容：**

|    key     |  type  | 是否必须 |           备注            |
| :--------: | :----: | :------: | :-----------------------: |
|    cmd     | string |    是    | 操作命令，`report_status` |
| client_id  | string |    是    |          设备id           |
|   light    | array  |    是    |        灯状态数组         |
| brightness | array  |    是    |       区域亮度数组        |

**参数说明：**

light：

|    key     |  type  | 是否必须 |          备注          |
| :--------: | :----: | :------: | :--------------------: |
|  location  | string |    是    |        区域名称        |
| lightIndex |  int   |    是    |   灯索引号，从0开始    |
|   status   |  int   |    是    | 灯的状态，0：开，1：关 |

brightness：

|    key     |  type  | 是否必须 |   备注   |
| :--------: | :----: | :------: | :------: |
|  location  | string |    是    | 区域名称 |
| brightness |  int   |    是    | 区域亮度 |

**示例：**

上报学校A，教学楼A栋1楼501室的设备状态。

主题：lightGateway

```json
{
  "cmd": "report_gateway_info",
  "client_id": "bf5365a6-e4a2-11ed-9cd1-00163e02d664",
  "light": [
    {
      "location": "A",
      "lightIndex": 0,
      "status": 0
    },
    {
      "location": "A",
      "lightIndex": 1,
      "status": 1
    }
  ],
  "brightness": [
    {
      "location": "A",
      "brightness": 50
    }
  ]
}
```

## 设备端指令

### 上传灯开关状态

**消息内容：**

| 协议头部   | 命令码    | 区域      | 位置     | 状态             |
| ---------- | --------- | --------- | -------- | ---------------- |
| 7-byte     | 1-byte    | 1-byte    | 1-byte   | 1-byte           |
| 见协议说明 | `10`(DEC) | `ASCII码` | `十进制` | `0:关灯, 1:开灯` |

示例：

```
// 上传A区域第1盏灯开关状态
55 AA 00 04 01 B8 93 0A 41 01 01
```

### 上传光照度传感器数值

**消息内容：**

| 协议头部   | 命令码    | 区域      | 数值     |
| ---------- | --------- | --------- | -------- |
| 7-byte     | 1-byte    | 1-byte    | 2-byte   |
| 见协议说明 | `11`(DEC) | `ASCII码` | `十进制` |

示例：

```
// 上传A区域灯光传感器亮度
55 AA 00 04 01 C1 D3 0B 41 00 32
```

